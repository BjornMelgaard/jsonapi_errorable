<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Jsonapi errorable by jsonapi-suite</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Jsonapi errorable</h1>
        <p></p>

        <p class="view"><a href="https://github.com/jsonapi-suite/jsonapi_errorable">View the Project on GitHub <small>jsonapi-suite/jsonapi_errorable</small></a></p>


        <ul>
          <li><a href="https://github.com/jsonapi-suite/jsonapi_errorable/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/jsonapi-suite/jsonapi_errorable/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/jsonapi-suite/jsonapi_errorable">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h3>
<a id="jsonapi_errorable" class="anchor" href="#jsonapi_errorable" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>jsonapi_errorable</h3>

<p>Global error handling compatible with <a href="http://jsonapi.org/format/#errors">the jsonapi.org spec</a></p>

<h3>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h3>

<p>Add to your ApplicationController:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">ApplicationController<span class="pl-e"> &lt; ActionController::Base</span></span>
  <span class="pl-k">include</span> <span class="pl-c1">JsonapiErrorable</span>

  rescue_from <span class="pl-c1">Exception</span> <span class="pl-k">do </span>|<span class="pl-smi">e</span>|
    handle_exception(e)
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p><strong>Note</strong>: This gem requires <code>active_model_serializers</code>, which overrides <code>render</code>.</p>

<h3>
<a id="global-error-handling" class="anchor" href="#global-error-handling" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Global Error Handling</h3>

<p>Once installed, all errors will return a valid error response. <code>raise "foo"</code> would render:</p>

<div class="highlight highlight-source-ruby"><pre>{
  <span class="pl-c1">errors:</span> [
    <span class="pl-c1">code:</span> <span class="pl-s"><span class="pl-pds">'</span>internal_server_error<span class="pl-pds">'</span></span>,
    <span class="pl-c1">status:</span> <span class="pl-s"><span class="pl-pds">'</span>500<span class="pl-pds">'</span></span>,
    <span class="pl-c1">title:</span> <span class="pl-s"><span class="pl-pds">'</span>Error<span class="pl-pds">'</span></span>,
    <span class="pl-c1">detail:</span> <span class="pl-s"><span class="pl-pds">"</span>We've notified our engineers and hope to address this issue shortly.<span class="pl-pds">"</span></span>,
    <span class="pl-c1">meta:</span> {}
  ]
}</pre></div>

<h3>
<a id="validation-error-handling" class="anchor" href="#validation-error-handling" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Validation Error Handling</h3>

<p>Given a record fails <a href="http://api.rubyonrails.org/classes/ActiveModel/Validations.html">validations</a>, you probably want to render a custom error message specific to the validation failure. Use <code>render_errors_for</code>:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">def</span> <span class="pl-en">create</span>
  post <span class="pl-k">=</span> <span class="pl-c1">Post</span>.<span class="pl-k">new</span>(post_params)

  <span class="pl-k">if</span> post.save
    render <span class="pl-c1">json:</span> post
  <span class="pl-k">else</span>
    render_errors_for(post)
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>Assuming the Post's <code>title</code> was missing, this would render:</p>

<div class="highlight highlight-source-ruby"><pre>{
  <span class="pl-c1">errors:</span> [
    {
      <span class="pl-c1">code:</span> <span class="pl-s"><span class="pl-pds">'</span>unprocessable_entity<span class="pl-pds">'</span></span>,
      <span class="pl-c1">status:</span> <span class="pl-s"><span class="pl-pds">'</span>422<span class="pl-pds">'</span></span>,
      <span class="pl-c1">title:</span> <span class="pl-s"><span class="pl-pds">'</span>Validation Error<span class="pl-pds">'</span></span>,
      <span class="pl-c1">detail:</span> <span class="pl-s"><span class="pl-pds">"</span>Title can't be blank<span class="pl-pds">"</span></span>,
      <span class="pl-c1">source:</span> { <span class="pl-c1">pointer:</span> <span class="pl-s"><span class="pl-pds">'</span>/data/attributes/title<span class="pl-pds">'</span></span> },
      <span class="pl-c1">meta:</span> { <span class="pl-c1">attribute:</span> <span class="pl-s"><span class="pl-pds">'</span>title<span class="pl-pds">'</span></span>, <span class="pl-c1">message:</span> <span class="pl-s"><span class="pl-pds">"</span>can't be blank<span class="pl-pds">"</span></span>
    }
  ]
}</pre></div>

<h3>
<a id="customizing-error-responses" class="anchor" href="#customizing-error-responses" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Customizing Error Responses</h3>

<p>You can customize an error's response by using <code>register_exception</code> in your controller. Let's say we want <code>ActiveRecord::RecordNotFound</code> to have status code <code>404</code> instead of <code>500</code>:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">ApplicationController<span class="pl-e"> &lt; ActionController::Base</span></span>
  <span class="pl-c"># ...installation code...</span>
  register_exception <span class="pl-c1">ActiveRecord</span>::<span class="pl-c1">RecordNotFound</span>, <span class="pl-c1">status:</span> <span class="pl-c1">404</span>
<span class="pl-k">end</span></pre></div>

<p>Would now render http status code <code>404</code>, with the error JSON containing <code>status: '404'</code> and <code>code: 'not_found'</code>.</p>

<p>Available options are:</p>

<ul>
<li>
<code>status</code>: An http status code</li>
<li>
<code>title</code>: Custom title</li>
<li>
<code>log</code>: Pass <code>false</code> to avoid logging the error</li>
<li>
<code>message</code>: Pass <code>true</code> to render the error's message directly. Alternatively, this can accept a proc, e.g. <code>register_exception FooError, message: -&gt;(e) { e.message.upcase }</code>
</li>
</ul>

<h3>
<a id="custom-exception-handler" class="anchor" href="#custom-exception-handler" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Custom Exception Handler</h3>

<p>The final option <code>register_exception</code> accepts is <code>handler</code>. Here you can inject your own error handling class that customizes <a href="https://bbgithub.dev.bloomberg.com/InfrastructureExperience/jsonapi_errorable/blob/master/lib/jsonapi_errorable/exception_handler.rb">JsonapiErrorable::ExceptionHandler</a>. For example:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">MyCustomHandler<span class="pl-e"> &lt; JsonapiErrorable::ExceptionHandler</span></span>
  <span class="pl-k">def</span> <span class="pl-en">status_code</span>(<span class="pl-smi">error</span>)
    <span class="pl-c"># ...customize...</span>
  <span class="pl-k">end</span>

  <span class="pl-k">def</span> <span class="pl-en">error_code</span>(<span class="pl-smi">error</span>)
    <span class="pl-c"># ...customize...</span>
  <span class="pl-k">end</span>

  <span class="pl-k">def</span> <span class="pl-en">title</span>
    <span class="pl-c"># ...customize...</span>
  <span class="pl-k">end</span>

  <span class="pl-k">def</span> <span class="pl-en">detail</span>(<span class="pl-smi">error</span>)
    <span class="pl-c"># ...customize...</span>
  <span class="pl-k">end</span>

  <span class="pl-k">def</span> <span class="pl-en">meta</span>(<span class="pl-smi">error</span>)
    <span class="pl-c"># ...customize...</span>
  <span class="pl-k">end</span>

  <span class="pl-k">def</span> <span class="pl-en">log</span>(<span class="pl-smi">error</span>)
    <span class="pl-c"># ...customize...</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span>

register_exception <span class="pl-c1">FooError</span>, <span class="pl-c1">handler:</span> <span class="pl-c1">MyCustomHandler</span></pre></div>

<p>If you would like to use the same custom handler for all errors, override <code>default_exception_handler</code>:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c"># app/controllers/application_controller.rb</span>
<span class="pl-k">def</span> <span class="pl-en">self.default_exception_handler</span>
  <span class="pl-c1">MyCustomHandler</span>
<span class="pl-k">end</span></pre></div>

<h3>
<a id="exception-handling-in-subclasses" class="anchor" href="#exception-handling-in-subclasses" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Exception Handling in Subclasses</h3>

<p>All controllers will inherit any registered exceptions from their parent. They can also add their own. In this example, <code>FooError</code> will only throw a custom status code when thrown from <code>FooController</code>:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">FooController<span class="pl-e"> &lt; ApplicationController</span></span>
  register_exception <span class="pl-c1">FooError</span>, <span class="pl-c1">status:</span> <span class="pl-c1">422</span>
<span class="pl-k">end</span></pre></div>

<h3>
<a id="custom-logger" class="anchor" href="#custom-logger" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Custom Logger</h3>

<p>You can assign any logger using <code>JsonapiErrorable.logger = your_logger</code></p>

<h3>
<a id="within-tests" class="anchor" href="#within-tests" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Within Tests</h3>

<p>You may want your tests to actually raise errors instead of returning error JSON. In this case use <code>disabled!</code> and <code>enabled</code>:</p>

<div class="highlight highlight-source-ruby"><pre>before <span class="pl-c1">:each</span> <span class="pl-k">do</span>
  <span class="pl-c1">JsonapiErrorable</span>.disabled!
<span class="pl-k">end</span>

it <span class="pl-s"><span class="pl-pds">'</span>renders correct error response<span class="pl-pds">'</span></span> <span class="pl-k">do</span>
  <span class="pl-c1">JsonapiErrorable</span>.enabled! <span class="pl-c"># enabled just for this test</span>
<span class="pl-k">end</span></pre></div>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/jsonapi-suite">jsonapi-suite</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>
